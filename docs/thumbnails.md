# Thumbnail Generation

StagVault can generate thumbnails for media items from git-based sources. Thumbnail generation is **disabled by default** and must be explicitly enabled.

## Overview

- **Opt-in**: Thumbnails are generated only when `--thumbnails` flag is used
- **Git sources only**: API providers (Pixabay, Pexels, Unsplash) provide their own preview URLs
- **Dual format**: PNG (transparent) and JPG (checkerboard background)
- **Multiple sizes**: Standard sizes from 24px to 256px
- **Parallel processing**: Uses 16 CPU workers for fast generation
- **Image insights**: JSON metadata extracted at 128px including color analysis and transparency detection

## Standard Sizes

| Name | Size | Use Case |
|------|------|----------|
| TINY | 24px | Inline icons, lists |
| SMALL | 32px | Small icon previews |
| ICON | 48px | Standard icon size |
| MEDIUM | 64px | Medium previews |
| LARGE | 96px | Large previews |
| XLARGE | 128px | Detail view, insights extraction |
| PREVIEW | 256px | Preview panels (max size) |

## Output Formats

Each thumbnail is generated in two formats:

- **PNG**: Transparent background preserved (RGBA)
- **JPG**: Checkerboard background for transparent images (85% quality)

## CLI Commands

### Generate Thumbnails

Thumbnails are **not** generated by default during sync. Use `--thumbnails` to enable:

```bash
# Sync without thumbnails (default)
stagvault sync

# Sync with thumbnail generation
stagvault sync --thumbnails

# Sync specific source with thumbnails
stagvault sync -s heroicons --thumbnails
```

Manual generation:

```bash
# Generate for all git sources
stagvault thumbnails generate

# Generate for specific source
stagvault thumbnails generate -s heroicons

# Generate specific sizes only
stagvault thumbnails generate -z 64 -z 128

# Force regenerate existing thumbnails
stagvault thumbnails generate --force
```

### View Statistics

```bash
stagvault thumbnails stats
```

Output:
```
Thumbnail Statistics
  Total: 128100
  Size: 248.8 MB

By Source:
  feather: 2009
  heroicons: 9016
  lucide: 11669
  phosphor-icons: 63504
  tabler-icons: 41902

By Size:
  24px (TINY): 18300
  32px (SMALL): 18300
  48px (ICON): 18300
  64px (MEDIUM): 18300
  96px (LARGE): 18300
  128px (XLARGE): 18300
  256px (PREVIEW): 18300
```

### Clear Thumbnails

```bash
# Clear all thumbnails
stagvault thumbnails clear

# Clear specific source
stagvault thumbnails clear -s heroicons

# Skip confirmation
stagvault thumbnails clear -y
```

## Image Insights

When generating thumbnails, an insights JSON file is created at 128px containing:

```json
{
  "avg_color": {"r": 0, "g": 0, "b": 0},
  "min_color": {"r": 0, "g": 0, "b": 0},
  "max_color": {"r": 0, "g": 0, "b": 0},
  "has_transparency": true,
  "fully_opaque": false,
  "alpha_min": 0,
  "alpha_max": 255,
  "original_width": 24,
  "original_height": 24,
  "rendered_size": 128,
  "native_size": 24,
  "is_square": true
}
```

### Insights Fields

| Field | Description |
|-------|-------------|
| `avg_color` | Average RGB color of all pixels |
| `min_color` | Minimum RGB values |
| `max_color` | Maximum RGB values |
| `has_transparency` | True if any pixels have alpha < 255 |
| `fully_opaque` | True if all pixels have alpha = 255 |
| `alpha_min` | Minimum alpha value (0-255) |
| `alpha_max` | Maximum alpha value (0-255) |
| `original_width` | Original image width |
| `original_height` | Original image height |
| `rendered_size` | Size at which insights were extracted |
| `native_size` | Native/intended size from SVG viewBox |
| `is_square` | Whether original dimensions are square |

## API Endpoints

### Get Thumbnail

```
GET /svault/media/{item_id}/thumbnail/{size}?format=png
GET /svault/media/{item_id}/thumbnail/{size}?format=jpg
```

Returns thumbnail in requested format (PNG default).

**Response Headers:**
- `Content-Type: image/png` or `image/jpeg`
- `Cache-Control: public, max-age=31536000`

**For API provider items:** Returns 301 redirect to provider's preview URL.

### Get Insights

```
GET /svault/media/{item_id}/insights
```

Response:
```json
{
  "item_id": "heroicons:arrow-right:outline",
  "insights": {
    "avg_color": {"r": 0, "g": 0, "b": 0},
    "has_transparency": true,
    ...
  }
}
```

### List Available Sizes

```
GET /svault/media/{item_id}/thumbnails
```

Response:
```json
{
  "item_id": "heroicons:arrow-right:outline",
  "available_sizes": [24, 32, 48, 64, 96, 128, 256],
  "formats": ["png", "jpg"]
}
```

## Library Usage

```python
from stagvault import StagVault

vault = StagVault("./data", "./configs")

# Sync with thumbnails (disabled by default)
await vault.sync("heroicons", thumbnails=True)

# Get thumbnail bytes
thumbnail = vault.thumbnail_generator.get_thumbnail(
    source_id="heroicons",
    item_id="arrow-right-outline",
    size=64,
    format="png"  # or "jpg"
)

# Get thumbnail file path
path = vault.thumbnail_generator.get_thumbnail_path(
    source_id="heroicons",
    item_id="arrow-right-outline",
    size=64,
    format="png"
)

# Get image insights
insights = vault.thumbnail_generator.get_insights(
    source_id="heroicons",
    item_id="arrow-right-outline"
)

# Get available sizes for an item
sizes = vault.thumbnail_generator.get_available_sizes(
    source_id="heroicons",
    item_id="arrow-right-outline"
)

# Get statistics
stats = vault.get_thumbnail_stats()
```

## Storage Structure

Thumbnails are stored with sharding for filesystem performance:

```
data/
└── thumbnails/
    ├── thumbnails.db              # SQLite metadata cache
    └── {source_id}/
        └── {id_prefix}/           # First 2 chars of item_id
            ├── {item_id}_{size}.png
            ├── {item_id}_{size}.jpg
            └── {item_id}_insights.json
```

Example:
```
data/thumbnails/heroicons/ar/arrow-right-outline_64.png
data/thumbnails/heroicons/ar/arrow-right-outline_64.jpg
data/thumbnails/heroicons/ar/arrow-right-outline_insights.json
```

## Checkerboard Background (JPG only)

JPG thumbnails render transparent images on a checkerboard pattern:

- Light squares: `#ffffff` (white)
- Dark squares: `#cccccc` (light grey)
- Square size: 8px

PNG thumbnails preserve transparency (RGBA).

## Supported Formats

Input formats that can be rendered as thumbnails:

- SVG (rendered via resvg)
- PNG
- JPEG
- GIF
- WebP
- BMP
- ICO

Output formats:
- PNG (transparent)
- JPG (with checkerboard for transparent images)

## Configuration

Custom thumbnail settings via Python:

```python
from stagvault.thumbnails import ThumbnailConfig, CheckerboardConfig

config = ThumbnailConfig(
    sizes=[32, 64, 128],  # Custom sizes
    jpg_quality=85,        # JPEG quality (1-100)
    workers=16,            # Parallel workers
    insights_size=128,     # Size for insights extraction
    checkerboard=CheckerboardConfig(
        light_color="#ffffff",
        dark_color="#e0e0e0",
        square_size=12,
    ),
)

generator = ThumbnailGenerator(data_dir, config=config)
```

## Performance

With 16 parallel workers:
- ~29 items/second
- ~18,300 items in ~10 minutes
- Each item generates 14 files (7 sizes × 2 formats) + 1 insights JSON
